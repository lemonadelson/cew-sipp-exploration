---
title: "SIPP Experimentation"
format: html
embed-resources: true
editor_options: 
  chunk_output_type: inline
---

# Setup 

This code taken from Census website, with some edits made to variables and file location.

```{r}
#Load the "data.table", "dplyr", and "bit64" libraries
require("data.table")
require("bit64")
require("dplyr")

#Read in the Primary Data file. Choose only the variables you want to read in in order to save on memory.
#This code assumes that your working directory is the same directory as the data.
ds <- c("/Users/mca141/Documents/Lumina/lumina-sipp/data/pu2020.csv")
pu <- fread(ds, sep = "|", select = c(
  
  #Common case identification variables
  'SSUID','PNUM','MONTHCODE','ERESIDENCEID','ERELRPE','SPANEL','SWAVE', 'TEHC_ST',
  
  #The base weight
  'WPFINWGT',
  
  #Common demographics variables, including age at time of interview (TAGE)
  #	and monthly age during the reference period (TAGE_EHC)
  'ESEX','TAGE','TAGE_EHC','ERACE', 'TRACE', 'EORIGIN','EEDUC','ECERT', 'EPROCERT', 'EED_SCRNR', 'EAFNOW',
  
  #Additional variables for analysis
  'TPTOTINC','EDEBT_ED','EJSEDDEBT','EOEDDEBT','TJSEDDEBTVAL','TOEDDEBTVAL','TDEBT_ED','TPEARN',
  # Parent/child variables
  'EPAR_SCRNR', 'ERP', 'RPNCHILD1', 'EANYKID', 'EPNPAR1'))

#Make sure all the column names are upper-case
names(pu) <- toupper(names(pu))

```

Other libraries I might need

```{r}
library(tidyverse)
library(haven)
library(srvyr)
```

# Exploration of full data set

Mean total ed debt by education level

```{r}
pu |>
  filter(
    EED_SCRNR == 2, # Not currently enrolled
    !is.na(TDEBT_ED) # Total ed debt not NA
  ) |>
  group_by(EEDUC) |>
  summarize(mean(TDEBT_ED))

```

Age breakdown
```{r}
pu |>
  group_by(TAGE) |>
  summarize() |>
  print(n = 90)
```

TAGE is age by year, 0-89.

Month breakdown

```{r}
pu |>
  filter(!is.na(TDEBT_ED),
         !is.na(TOEDDEBTVAL),
         !is.na(TJSEDDEBTVAL)) |>
  group_by(MONTHCODE) |>
  summarize(sum(TDEBT_ED),
            "testsum" = sum(TOEDDEBTVAL) + sum(TJSEDDEBTVAL),
            sum(TOEDDEBTVAL),
            sum(TJSEDDEBTVAL)
            )
```

Reference month is recorded, but it doesn't seem to be used for education debt - all months have same number of observations and values.

Spouse stuff

```{r}
pu |>
  filter(!is.na(TDEBT_ED),
         !is.na(TOEDDEBTVAL)) |>
  group_by(MONTHCODE) |>
  summarize(sum(TDEBT_ED),
            "testdiff" = sum(TDEBT_ED) - sum(TOEDDEBTVAL),
            sum(TOEDDEBTVAL)
            )
```

Amounts owed jointly with spouse are smaller by a couple orders of magnitude (when summed).

Certs/educ

```{r}
pu |>
  # filter(EEDUC %in% c(40,41)) |>
  group_by(ECERT,EEDUC) |>
  summarize(n()) |>
  print(n=41)
```


# Create Dec-only data frame

```{r}
#| label: Create sippdec


sippdec <- pu |>
  filter(
    MONTHCODE == 12,
    !is.na(EEDUC)
  ) |>
  
  # Create education groups
  mutate(
    educ_grp = case_when(
      EEDUC <= 39 ~ "1_HS or less",
      EEDUC %in% c(40,41) ~ "2_Some college",
      EEDUC == 42 ~ "3_AA",
      EEDUC == 43 ~ "4_BA",
      EEDUC == 44 ~ "5_MA",
      EEDUC == 45 ~ "6_Professional degree",
      EEDUC == 46 ~ "7_Doctorate degree",
      TRUE ~ NA
    ),
    
    # Add certificates
    educ_grp_cert = case_when(
      educ_grp %in% c("1_HS or less", "2_Some college") & ECERT == 1 ~ "8_Certificate",
      educ_grp %in% c("1_HS or less", "2_Some college") & EPROCERT == 1 ~ "8_Certificate",
      TRUE ~ educ_grp
    ),
    
    # Add age groups
    age_grp = case_when(
      TAGE_EHC >= 18 & TAGE_EHC <= 24 ~ "18 to 24",
      TAGE_EHC >= 25 & TAGE_EHC <= 34 ~ "25 to 34",
      TAGE_EHC >= 35 & TAGE_EHC <= 44 ~ "35 to 44",
      TAGE_EHC >= 45 & TAGE_EHC <= 64 ~ "45 to 64",
      TRUE ~ NA
    ),
    
    # Combine race and ethnicity
    raceeth =  case_when(
      EORIGIN == 1 ~ "Hispanic/Latino",
      TRACE == 1 ~ "White",
      TRACE == 2 ~ "Black",
      TRACE == 3 ~ "American Indian/Alaska Native",
      TRACE == 4 ~ "Asian/Asian American",
      TRACE == 5 ~ "Native Hawaiian/Pacific Islander",
      TRACE >= 6 ~ "More than one race/ethnicity",
      TRUE ~ NA
    )
  )
  
```

Create 4 education groups (incorporated into "Create sippdec")
```{r}
#| eval: false
#| include: false


# sippdec <- sippdec |>
#   filter(!is.na(EEDUC)) |>
#   mutate(
#     educ_grp = case_when(
#       EEDUC <= 39 ~ "HS or less",
#       EEDUC %in% c(40,41) ~ "Some college",
#       EEDUC == 42 ~ "AA",
#       EEDUC == 43 ~ "BA",
#       TRUE ~ "Graduate"
#     )
#   )
```

Add certificates (incorporated into "Create sippdec")
```{r}
#| eval: false
#| include: false

# sippdec <- sippdec |>
#   mutate(
#     educ_grp_cert = case_when(
#       educ_grp %in% c("HS or less", "Some college") & ECERT == 1 ~ "Certificate",
#       educ_grp %in% c("HS or less", "Some college") & EPROCERT == 1 ~ "Certificate",
#       TRUE ~ educ_grp
#     )
#   )

```

Create age groups (incorporated into "Create sippdec")
```{r}
#| eval: false
#| include: false


# sippdec <- sippdec |>
#   mutate(
#     age_grp = case_when(
#       TAGE_EHC >= 18 & TAGE_EHC <= 24 ~ "18 to 24",
#       TAGE_EHC >= 25 & TAGE_EHC <= 34 ~ "25 to 34",
#       TAGE_EHC >= 35 & TAGE_EHC <= 44 ~ "35 to 44",
#       TAGE_EHC >= 45 & TAGE_EHC <= 64 ~ "45 to 64",
#       TRUE ~ NA
#     )
#   )

```


## Convert to survey object

```{r}
sippdecsvy <- sippdec |> as_survey_design(weights = WPFINWGT)
```

# Descriptive statistics (Dec 2019)

Count of all observations
```{r}
sippdecsvy |> survey_count()
# 265,471,419 weighted observations

```

Mean and median age
```{r}
sippdecsvy |> summarize(survey_mean(TAGE_EHC))
# Mean = 46.2

sippdecsvy |> summarize(medage = survey_median(TAGE_EHC))
# Median = 46

```

Mean age (completers, not currently enrolled)
```{r}
sippdecsvy |>
  filter(
    EED_SCRNR == 2,
    educ_grp_cert %in% c("AA", "BA", "Graduate", "Certificate"),
         TOEDDEBTVAL > 0) |> summarize(meanage = survey_mean(TAGE_EHC))
# Mean = 39

sippdecsvy |>
  filter(
    EED_SCRNR == 2,
    educ_grp_cert %in% c("AA", "BA", "Graduate", "Certificate"),
         TOEDDEBTVAL > 0) |> summarize(medage = survey_median(TAGE_EHC))
# Median = 37

```


Gender breakdown
```{r}
sippdecsvy |> group_by(ESEX) |> summarize(survey_prop())
# 51.6% female, 48.4% male

```

Race/ethnicity breakdown

```{r}
sippdecsvy |> group_by(raceeth) |> survey_count()
#  raceeth                                   n    n_se
# 1 American Indian/Alaska Native      1500180.  96742.
# 2 Asian/Asian American              16480940. 362202.
# 3 Black                             31802000. 533623.
# 4 Hispanic/Latino                   45297695. 568669.
# 5 More than one race/ethnicity       5161401. 197367.
# 6 Native Hawaiian/Pacific Islander    567135.  65311.
# 7 White                            164662067. 742775.

sippdecsvy |> group_by(raceeth) |> summarize(survey_prop())
#  raceeth                             coef    `_se`
# 1 American Indian/Alaska Native    0.00565 0.000365
# 2 Asian/Asian American             0.0621  0.00135 
# 3 Black                            0.120   0.00193 
# 4 Hispanic/Latino                  0.171   0.00208 
# 5 More than one race/ethnicity     0.0194  0.000742
# 6 Native Hawaiian/Pacific Islander 0.00214 0.000246
# 7 White                            0.620   0.00267 

```

State breakdown
```{r}
sippdecsvy |> 
  group_by(TEHC_ST) |> 
  survey_count() |>
  print (n = 55)

```


# Simple analyses

## Debt by education level

Table: total loans owned in own name, disaggregated by education, not currently enrolled

```{r}

sippdecsvy |>
  filter(EED_SCRNR == 2,
         educ_grp_cert %in% c("AA", "BA", "Graduate", "Certificate"),
         TOEDDEBTVAL > 0,
         # TAGE_EHC > 24,
         # TAGE_EHC < 66
         ) |>
  group_by(educ_grp_cert) |>
  summarize(meddebt = survey_median(TOEDDEBTVAL))
  
```

Count of observations

```{r}

sippdec |>
  filter(EED_SCRNR == 2,
         educ_grp_cert %in% c("AA", "BA", "Graduate", "Certificate"),
         TOEDDEBTVAL > 0,
         # TAGE_EHC > 24,
         # TAGE_EHC < 66
         ) |>
  group_by(educ_grp_cert) |>
  summarize(n())
  
```

## Debt by education level (detailed graduates)

```{r}
# Graduate degrees
sippdecsvy |>
  filter(EED_SCRNR == 2,
         educ_grp_cert == "Graduate",
         TOEDDEBTVAL > 0,
         ) |>
  group_by(EEDUC) |>
  summarize(meddebt = survey_median(TOEDDEBTVAL))

# Professional cert
sippdecsvy |>
  filter(EED_SCRNR == 2,
         EPROCERT == 1,
         TOEDDEBTVAL > 0,
         ) |>
  group_by(EPROCERT) |>
  summarize(meddebt = survey_median(TOEDDEBTVAL))
  
```

## Debt by age group

```{r}

sippdecsvy |>
  filter(EED_SCRNR == 2,
         educ_grp_cert %in% c("AA", "BA", "Graduate", "Certificate"),
         TOEDDEBTVAL > 0,
         !is.na(age_grp),
         ) |>
  group_by(age_grp) |>
  summarize(meddebt = survey_median(TOEDDEBTVAL))
  
```

## Debt by race/ethnicity

```{r}
sippdecsvy |>
  filter(EED_SCRNR == 2,
         educ_grp_cert %in% c("AA", "BA", "Graduate", "Certificate"),
         TOEDDEBTVAL > 0,
         !is.na(raceeth),
         ) |>
  group_by(raceeth) |>
  summarize(meddebt = survey_median(TOEDDEBTVAL))

```


# Multivariate analyses


## Median education loans by highest credential and age

```{r}

sippdecsvy |>
  filter(EED_SCRNR == 2,
         educ_grp_cert %in% c("3_AA", "4_BA", "5_MA", "6_Professional degree", "7_Doctorate degree", "8_Certificate"),
         TOEDDEBTVAL > 0,
         TPEARN > 0,
         !is.na(age_grp)
         ) |>
  group_by(age_grp, educ_grp_cert) |>
  summarize(
    meddebt = survey_median(TOEDDEBTVAL),
    medearn_month = survey_median(TPEARN),
    unw_count = n()) |>
  print (n = 22)

```


## Median education loans by highest credential and race/ethnicity

```{r}

sippdecsvy |>
  filter(EED_SCRNR == 2,
         educ_grp_cert %in% c("AA", "BA", "Graduate", "Certificate"),
         TOEDDEBTVAL > 0,
         !is.na(raceeth)
         ) |>
  group_by(raceeth, educ_grp_cert) |>
  summarize(meddebt = survey_median(TOEDDEBTVAL), unw_count = n()) |>
  print(n = 30)

```

## Median education loans by highest credential and state

```{r}

sippdecsvy |>
  filter(EED_SCRNR == 2,
         educ_grp_cert %in% c("AA", "BA", "Graduate", "Certificate"),
         TOEDDEBTVAL > 0,
         !is.na(TEHC_ST),
         TEHC_ST <= 60
         ) |>
  group_by(TEHC_ST, educ_grp_cert) |>
  summarize(meddebt = survey_median(TOEDDEBTVAL), unw_count = n()) |>
  print(n = 210)

```


## Median education loans by highest credential, race/ethnicity, and state

```{r}
state_educ_raceeth <- sippdecsvy |>
  
  filter(EED_SCRNR == 2,
         educ_grp_cert %in% c("AA", "BA", "Graduate", "Certificate"),
         TOEDDEBTVAL > 0,
         !is.na(TEHC_ST),
         !is.na(raceeth),
         TEHC_ST <= 60
         ) |>
  group_by(TEHC_ST, educ_grp_cert, raceeth) |>
  summarize(meddebt = survey_median(TOEDDEBTVAL), unw_count = n()) |>
  print(n = 500)
```

Save as CSV
```{r}
#| eval: false

state_educ_raceeth |> write_csv("data/state_educ_raceeth.csv")
```


## Debt by education level and age

```{r}
sippdecsvy |>
  filter(
    EED_SCRNR == 2,
    educ_grp_cert %in% c("AA", "BA", "Graduate", "Certificate"),
    TOEDDEBTVAL > 0,
    !is.na(age_grp)
         ) |>
  mutate(
    educ_grp_2 = if_else(
      educ_grp_cert == "Graduate", "G", "UG")
    ) |>
  group_by(age_grp, educ_grp_2) |>
  summarize(meddebt = survey_median(TOEDDEBTVAL)) |>
  arrange(age_grp, desc(educ_grp_2))

```


# Experimental analyses

## Identifying possible parents of college students

* EPAR_SCRNR: Shows whether a respondent is a parent (biological, step, or adoptive)
** 1 = Yes, 2 = No

* ERP: Identifies if adult is a reference parent to any household children under 18 years old
** 1 = Yes, 2 = No

* RPNCHILD1: Person number of child 1
** 101:499 (or NA)

* EANYKID: Did ... have any children under 21 years of age who lived elsewhere with their other parent or guardian at any time during the reference period?
** 1 = Yes, 2 = No

EPAR_SCRNR / RPNCHILD1

```{r}
sippdec |>
  group_by(EPAR_SCRNR, RPNCHILD1) |>
  summarize(max(RPNCHILD1), n()) |>
  print(n = 30)

# If respondent is not a parent (EPAR_SCRNR == 2), RPNCHILD1 is NA.
# However, if respondent IS a parent, RPNCHILD1 may also be NA.

```

EPAR_SCRNR / EANYKID

```{r}

sippdec |>
  filter(is.na(RPNCHILD1)) |>
  group_by(EPAR_SCRNR, EANYKID) |>
  summarize(n())

#   EPAR_SCRNR EANYKID `n()`
#        <int>   <int> <int>
# 1          1       1   697
# 2          1       2 13340
# 3          1      NA   862
# 4          2      NA 14366

# A large number of respondents are parents (EPAR_SCRNR == 1) but do not have any children in the household (RPNCHILD1 is NA) AND do not have children living with another parent or guardian (EANYKID == 2).

# Children who are away at school are still generally considered part of the household, so this may be capturing adult children who are not in school
```

Child in household 18-24

Create child data frame
```{r}
sippdec_1824 <- sippdec |>
  filter(!is.na(EPNPAR1),
         age_grp == "18 to 24") |>
  select(SSUID, PNUM, ERESIDENCEID, ERELRPE, EED_SCRNR, TEHC_ST, WPFINWGT, ESEX, TAGE_EHC, TOEDDEBTVAL, TDEBT_ED, EPNPAR1, educ_grp_cert, raceeth)
  
```

Identify parents of children
```{r}
sippdec |>
  filter(ERESIDENCEID %in% sippdec_1824$ERESIDENCEID,
         EPAR_SCRNR == 1) |>
  summarize(n())
  
```


## Identifying recent completers


## Analysis by income level
